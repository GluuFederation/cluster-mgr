# Change to appropriate ServerID and FQDN

serverid x

# Schema files.
include         "/opt/symas/etc/openldap/schema/core.schema"
include         "/opt/symas/etc/openldap/schema/ppolicy.schema"
include         "/opt/symas/etc/openldap/schema/cosine.schema"
include         "/opt/symas/etc/openldap/schema/inetorgperson.schema"
include         "/opt/symas/etc/openldap/schema/eduperson.schema"
include         "/opt/gluu/schema/openldap/gluu.schema"
include         "/opt/gluu/schema/openldap/custom.schema"


# TLS Setup Section

TLSCACertificateFile "/etc/certs/openldap.pem"
TLSCertificateFile "/etc/certs/openldap.crt"
TLSCertificateKeyFile "/etc/certs/openldap.key"

TLSCipherSuite HIGH:MEDIUM

# Files in which to store the process id and startup arguments.
# These files are needed by the init scripts, so only change
# these if you are prepared to edit those scripts as well.
pidfile                 "/var/symas/run/slapd.pid"
argsfile                "/var/symas/run/slapd.args"

# Modules
modulepath      "/opt/symas/lib64/openldap"
moduleload      back_mdb.la
moduleload      back_monitor.la
moduleload      ppolicy.la
moduleload      syncprov.la
moduleload      accesslog.la
moduleload      pw-bcrypt.la
moduleload      unique.la

access to dn="" by * read
access to dn.subtree="o=gluu"
        by dn.exact="cn=directory manager,o=gluu" write
        by * tls_ssf=128 read
access to dn.subtree="cn=monitor"
        by * read
access to *
        by self write
        by users read
        by anonymous auth

loglevel stats sync

password-hash {BCRYPT}

#######################################################################
# Main Database housing all the o=gluu info
#######################################################################
database        mdb
suffix          "o=gluu"
rootdn          "cn=directory manager,o=gluu"
rootpw          {Your hash password here}

index   default         eq
index   objectClass
index   uid eq,sub
index   cn eq,sub
index   mail eq,sub
index   owner
index   member
index   givenName eq,sub
index   uniqueMember
index   entryUUID eq
index   entryCSN eq
index   displayName
index   description
index   iname
index   inum
index   uniqueIdentifier
index   oxAuthSessionId
index   oxId
index   oxExternalUid
index   oxRequestId
index   oxAuthClientId
index   oxAuthGrantId
index   oxAuthAuthorizationCode
index   oxAuthTokenCode
index   oxSectorIdentifier
index   oxState
index   oxAuthExpiration
index   oxApplication
index   creationDate
index   oxLastAccessTime
index   oxStartDate
index   oxEndDate
index   oxApplicationType
index   oxMetricType
index   oxDeviceHashCode
index   oxAuthSessionDn
index   oxScriptType
index   gluuStatus

directory       "/opt/gluu/data/main_db"
maxsize 1073741824

#######################################################################
###                             SYNCREPL                            ###
#######################################################################

# Each server needs a separate rid=#. If they're the same CPU and memory usage might spike.
# Insert a syncrepl portion for each server being replicated, excluding the server this 
# slapd.conf exists on.

syncrepl
        rid=002
        provider=ldaps://{Insert server FQDN here i.e. c2.gluu.org}
        tls_reqcert=never
        bindmethod=simple
        binddn="{Insert main_db rootdn credentials i.e. "cn=directory manager,o=gluu"}
        credentials={Your hash password for your bindDN}
        type=refreshAndPersist
        searchbase="{insert base dn here i.e. o=gluu}"
        filter="(objectclass=*)"
        scope=sub
        retry="5 10 60 +"
        logbase="cn=accesslog"
        logfilter="(&(objectClass=auditWriteObject)(reqResult=0))"
        syncdata=accesslog
        sizeLimit=unlimited
        timelimit=unlimited

# SYNCREPL [LDAP2, GluuM02]

syncrepl
        rid=003
        provider=ldaps://{Insert server FQDN here i.e. c3.gluu.org}
        tls_reqcert=never
        bindmethod=simple
        binddn="{Insert binddn credentials i.e. "cn=directory manager,o=gluu"}
        credentials={Your hash password for your bindDN}
        type=refreshAndPersist
        searchbase="{insert base dn here i.e. o=gluu}"
        filter="(objectclass=*)"
        scope=sub
        retry="5 10 60 +"
        logbase="cn=accesslog"
        logfilter="(&(objectClass=auditWriteObject)(reqResult=0))"
        syncdata=accesslog
        sizeLimit=unlimited
        timelimit=unlimited

# ENABLE MIRROR MODE
mirrormode TRUE

#-----------------------------------------------------------------


# Load an instance of the ppolicy overlay for the current database:
overlay ppolicy
ppolicy_hash_cleartext

# Specify the default password policy subentry to use when none is
# specified in an account's entry
ppolicy_default "cn=default,ou=policies,o=gluu"

overlay syncprov

syncprov-checkpoint 100 10
syncprov-sessionlog 10000
syncprov-reloadhint TRUE

# Uniqueness enforcement
overlay unique
unique_uri      ldap:///?uid?sub?(objectClass=gluuPerson)
unique_uri      ldap:///?mail?sub?(objectClass=gluuPerson)

# Audit Logging
# Enable audit logging for extra security. But be aware it will reduce performance!
#overlay                auditlog
#auditlog       /var/log/openldap/auditlog.ldif

## Accesslog configuration
overlay     accesslog
logdb       "cn=accesslog"
logops      writes
logsuccess  TRUE
logpurge 24:00 01+00:00

#######################################################################
# Site database housing o=site information
#######################################################################
database        mdb
suffix          "o=site"
rootdn          "cn=directory manager,o=site"
rootpw          {Hash password for site database rootdn goes here}
directory       "/opt/gluu/data/site_db"
maxsize 1073741824

# Indices to maintain

# index default sets the basic type of indexing to perform if there isn't any indexing specified for a given attribute
index   default         eq
index   objectClass
index   inum
index   gluuStatus

#######################################################################
# Monitor database
#######################################################################
database        monitor

#######################################################################
# Config database
#######################################################################
database    config
rootdn      "cn=admin,cn=config"
rootpw      {Hash password for the config rootdn goes here}

########################################################################
## Access Log database
########################################################################
database    mdb
#directory   /var/lib/openldap-data/accesslog
directory   /opt/gluu/data/accesslog_db
maxsize     5120000
suffix      "cn=accesslog"
rootdn      "cn=accesslog"
rootpw      {Hash password for the accesslog rootdn goes here}
index   default eq
index   objectClass,entryCSN,entryUUID,reqEnd,reqResult,reqStart

# The following two DN's must match what you have for your rootdn 
# of your main database

access to *
        by  dn="cn=directory manager,o=gluu"   read
        by  dn="cn=directory manager,o=gluu"   write
        by  dn="cn=config" read

overlay syncprov
syncprov-nopresent TRUE
syncprov-reloadhint TRUE
syncprov-checkpoint 100 10
syncprov-sessionlog 10000
