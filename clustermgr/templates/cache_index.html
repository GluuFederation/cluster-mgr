{% extends "base.html" %}

{% block header %}
  <h1>Cache Management</h1>
  <ol class="breadcrumb">
    <li><i class="fa fa-home"></i> <a href="{{ url_for('index.home') }}">Home</a></li>
    <li class="active">Cache Management</li>
  </ol>
{% endblock %}

{% block content %}
<form method="get" action="{{ url_for('cache_mgr.install')}}">



<div class="panel panel-primary">
  <div class="panel-heading">Gluu Servers</div>
    <div class="panel-body">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Server ID</th>
            <th>Hostname</th>
            <th>IP Address</th>
            <th class="text-center">Stunnel Status</th>
          </tr>
        </thead>
        <tbody>
          {% for server in servers %}
          <tr id="server_{{server.id}}">
            <td class="id">{{server.id}}</td>
            <td class="hostname">{{server.hostname}}</td>
            <td class="ip">{{server.ip}}</td>
            <td align="center"> <span class="badge" id="stunnelstat-{{server.ip.replace('.','_')}}"></span> </td>
            
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
</div>

{% if cache_servers %}


<div class="panel panel-primary">
  <div class="panel-heading">Cache Servers</div>
    <div class="panel-body">


      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Hostname</th>
            <th>IP Address</th>
            <th class="text-center">Redis Status</th>
            <th class="text-center">Stunnel Status</th>
          </tr>
        </thead>
        <tbody>
          {% for server in cache_servers %}
          <tr>
            <td class="hostname">{{server.hostname}}</td>
            <td class="ip">{{server.ip}}</td>
            <td align="center"> <span class="badge" id="redisstat-{{server.ip.replace('.','_')}}"></span> </td>
            <td align="center"> <span class="badge" id="stunnelstat-{{server.ip.replace('.','_')}}"></span> </td>
            
          </tr>
          {% endfor %}
        </tbody>
      </table>


    </div>
</div>


<input type="submit" class="btn btn-success btn-block" value="Setup Cache">

{% endif %}
</form>


<div class="row">
<div class="col-md-8">
<div id="cacheSettingsPanel" class="panel panel-warning" style="display: none">
    <div class="panel-heading">Cache Settings</div>
    <div class="panel-body">
 
    <form class="form-horizontal" action="">

        <div class="form-group {{ 'has-error' if form.redis_port.errors else '' }}">
          
          {{ form.redis_port.label(class="control-label col-sm-2") }}
          
          <div class="col-sm-10">
            
            
            {{ form.redis_port(class="form-control") }}
            {% for error in form.redis_port.errors %}
                <p class="help-block">{{ error }}</p>
            {% endfor %}
            
          </div>
        </div>


        <div class="form-group">        
          <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" class="btn btn-default">Submit</button>
          </div>
        </div>
    
    </form>
 
</div>

  
</div>
</div>

{% endblock %}


{% block js %}
<script>


function cacheStat() {


    $.get("{{request.host_url}}cache/status/", function(data, status){
        for (var key in data.redis) {
            
            if (data.redis[key]) {
                $("#redisstat-"+key).addClass("bg-green");
                $("#redisstat-"+key).text("Live");
            } else {
            
                $("#redisstat-"+key).addClass("bg-red");
                $("#redisstat-"+key).text("Down");
            }
        }
            
        for (var key in data.stunnel) {
            console.log('data:'+data.stunnel[key]);
            console.log('key:'+key);
            
            
            if (data.stunnel[key]) {
                
                $("#stunnelstat-"+key).addClass("bg-green");
                $("#stunnelstat-"+key).text("Live");
            } else {
                $("#stunnelstat-"+key).addClass("bg-red");
                $("#stunnelstat-"+key).text("Down");
            }
            
            console.log("KK"+ $("#stunnelstat-"+key).text());
        }
    
    });
    

}

cacheStat();


$('#cacheSettingsBtn').click(function(){
    
        $('#cacheSettingsPanel').removeAttr("style");

  });
  
  
  
</script>
{% endblock %}
