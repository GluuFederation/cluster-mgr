{% extends "base.html" %}
{% block content %}
<div id="alert" class="alert alert-info" role="alert">
    A slapd.conf file has been generated with the information you provided. Edit the config to suit any specific requirements.
</div>
<div class="panel panel-default" id="editor-panel">
  <div class="panel-heading">slapd.conf</div>
  <div class="panel-body" style="padding:0;">
    <div id="editor" style="height: 500px;">{{ config }}</div>
  </div>
</div>

<a id="submit" class="btn btn-primary" href="#">Setup LDAP Server</a>

{% if mirror %}
<div class="row">
    <div class="col-md-6 col-sm-12">
        <div class="page-header" style="display: none;">
            <h3>Setting up your server: <small>{{ server.hostname }}</small></h3>
        </div>
        <pre id="log{{ server.id }}" style="display:none;">
        </pre>
    </div>
    <div class="col-md-6 col-sm-12">
        <div class="page-header" style="display: none;">
            <h3>Setting up your server: <small>{{ mirror.hostname }}</small></h3>
        </div>
        <pre id="log{{ mirror.id }}" style="display:none;">
        </pre>
    </div>
</div>

{% else %}
<div class="page-header" style="display: none;">
    <h3>Setting up your server: <small>{{ server.hostname }}</small></h3>
</div>
<pre id="log" style="display:none;">
</pre>

{% endif %}

<a id="gohome" class="btn btn-success btn-block" href="/" style="display:none;">Go to Dashboard</a>
{% endblock content %}


{% block js %}
<script src="{{ url_for('static', filename='js/ace/ace.js') }}" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/xcode");
    editor.getSession().setMode("ace/mode/ini");
    var log_url;
    var tid;

    {# -------------------------- Mirrormode JS ---------------------------#}
    {% if mirror %}
    var server_id = {{ server.id }};
    var mirror_id = {{ mirror.id }};
    var server_timer, mirror_timer;

    $('#submit').click(function(){
        var conf = editor.getValue();
        $.post('{{ url_for("mirror", sid1=server.id, sid2=mirror.id) }}', {conf: conf}).done(
                function(data){
                    $('#editor-panel').hide();
                    $('#submit').hide();
                    $('#alert').hide();

                    $('.page-header, #log'+server_id+', #log'+mirror_id).show();
                    server_timer = setInterval(updateLog, 1000, data['url1'], server_id);
                    mirror_timer = setInterval(updateLog, 1000, data['url2'], mirror_id)
                });
    });

    function updateLog(url, id){
        $.get(url, function(data){
            var log = '';
            for(var i=0; i<data.messages.length; i++){
                log += "\n"+ data.messages[i].msg;
            }
            $('#log'+id).text(log);

            if(data.state == 'SUCCESS' || data.state == 'FAILURE'){
                /**
                  TODO: Ensure that the deployment was sucessful. Verify using the following report from the log

                  Symas OpenLDAP LDAP services slapd starting...  done.

                  */
                if( id == server_id){
                    clearInterval(server_timer);
                    server_timer = 0;
                } else if( id == mirror_id ){
                    clearInterval(mirror_timer);
                    mirror_timer = 0;
                }
                if( server_timer + mirror_timer == 0){
                    $('#gohome').show();
                }
            }
        });
    }

    {# -------------------------- Delta-syncrepl JS ---------------------------#}
    {% else %}
    var server_id = {{ server.id }};
    $('#submit').click(function(){
        var conf = editor.getValue();
        $.post('{{ url_for("configure_server", server_id=server.id) }}', {conf: conf}).done(
                function(data){
                    log_url = data.url;
                    $('#editor-panel').hide();
                    $('#submit').hide();
                    $('#alert').hide();

                    $('#log, .page-header').show();
                    tid = setInterval(updateLog, 1000);
                });
    });

    function updateLog(){
        $.get(log_url, function(data){
            var log = '';
            for(var i=0; i<data.messages.length; i++){
                log += "\n"+ data.messages[i].msg;
            }
            $('#log').text(log);
            if(data.state == 'SUCCESS' || data.state == 'FAILURE'){
                clearInterval(tid);
                $('#gohome').show();
            }
        });
    }

    {% endif %}

</script>
{% endblock js %}
