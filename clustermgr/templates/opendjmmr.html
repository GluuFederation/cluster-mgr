{% extends "base.html" %}
{% from 'macros.html' import render_form %}

{% block header %}
    <h1>Multi Master Replication [WrenDS]</h1>
  <ol class="breadcrumb">
    <li><i class="fa fa-home"></i> <a href="{{ url_for('index.home') }}">Home</a></li>
    <li class="active">LDAP Replication</li>
  </ol>
{% endblock %}

{% block  content %}

{% if servers %}
<div class="box">
    <div class="box-body no-padding">
        <table id="servers" class="table table-bordered">
            <thead>
                <tr>
                    <th>Server ID</th>
                    <th>Hostname</th>
                    <th>IP Address</th>
                    <th>Replication Status</th>
                    <th>Server Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for server in servers %}
                <tr>
                    <td>{{ server.id }}</td>
                    <td>{{ server.hostname }}
                        {% if server.primary_server %}
                        <span class="badge bg-green">Primary</span>
                        {% endif %}
                    </td>
                    <td>{{ server.ip }}</td>
                    <td>
                        {% if not server.primary_server %}
                            {% if server.mmr %}
                                Configured
                            {% else %}
                                <p class="text-danger">Not Configured</p>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td><center> <span class="badge" id="ldapstat{{server.id}}"></span> </center></td>
                    <td>
                    {% if stat %}
                        {% if not server.primary_server %}
                            <a class="btn btn-primary btn-xs" href="{{ url_for('replication.opendj_enable_replication', server_id=server.id) }}">
                                {% if server.mmr %}Re-Enable Replication{%else%}Enable Replication{%endif%}</a>
                            {% if server.mmr %}
                            <a class="btn btn-primary btn-xs" href="{{ url_for('replication.opendj_disable_replication', server_id=server.id) }}">Disable Replication</a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
     
</div>

{% if not app_conf.replication_pw %}

<a class="btn btn-success btn-xs" href="#" id="set-password">Set Replication Manager Password</a>


{% else %}

<a class="btn btn-info btn-xs" href="#" id="view-password">View Replication Manager Password</a>

{% endif %}
<br><br>

<b>Note:</b>Ports 4444 and 8989 should be open to/from among all nodes of cluster pool.



<a class="btn pull-right btn-primary btn-xs" href="{{ url_for('replication.opendj_enable_replication', server_id='all') }}">
        {% if stat %}Re-Deploy All{%else%}Deploy All{%endif%}</a>
<br>

{% endif %}

{% if stat %}
  <br>
  <br>
  <label>Replication Status:</label>
  <pre>
{{ stat }}  
  </pre>
{% endif %}


<!-- Set Replication Manager Password Modal Begin-->
<div id="setReplicationPasswordModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
  <form class="form-horizontal" id="set-replication-password-form" action="{{ url_for('replication.set_replication_password') }}" method="POST">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="modal-title">Set Replication Password</h4>
      </div>
      <div class="modal-body" id="modal-body">

          <div class="form-group">
            <label class="control-label col-sm-4" for="replication_password">Password:</label>
            <div class="col-sm-8">
            <input type="password" name="replication_password" id="rep-password">
            </div>
          </div>

          <div class="form-group">
            <label class="control-label col-sm-4" for="replication_password1">Retype Password:</label>
            <div class="col-sm-8">
            <input type="password" id="rep-password2">
            </div>
          </div>

      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-default" data-dismiss="modal">Close</a> <a href="#" class="btn btn-primary" id="set-password-button">Set Password</a>
      </div>
    </div>
    
  </form>
 </div>
</div>
<!-- Set Replication Manager Password Modal End-->


{% endblock %}
{% block js %}

<script>
function showLdapStat() {

{% for server in servers %}

    $.get("{{request.host_url}}server/ldapstat/{{server.id}}/", function(data, status){
        if (data == 1) {
            $("#ldapstat{{server.id}}").addClass("bg-green");
            $("#ldapstat{{server.id}}").removeClass("bg-red");
            $("#ldapstat{{server.id}}").text("Live");
        } else {
            
            $("#ldapstat{{server.id}}").addClass("bg-red");
            $("#ldapstat{{server.id}}").removeClass("bg-green");
            $("#ldapstat{{server.id}}").text("Down");
        }
        
    
    });
    
{% endfor %}

}

showLdapStat();

setInterval(function() {
    showLdapStat();
}, {% if app_conf.ldap_update_period %}{{app_conf.ldap_update_period}}{%else%}5{%endif%}*60*1000);


$("#set-password").click(function(e){


  $('#setReplicationPasswordModal').modal('show');

});

$("#set-password-button").click(function(e){
  e.preventDefault();
  
  var pw1 = $("#rep-password").val();
  var pw2 = $("#rep-password2").val();
  
  
  if ( pw1.length < 5) {
      alert("Password length should be at least 5 characters.");
  } else if (pw1 != pw2) {
      alert("Passwords do not match.");
  } else {
      
      $('#set-replication-password-form').submit();
  }
  
});

function decode_base64(s) {
  var b=l=0,
  m='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
  return decodeURIComponent(s.replace(/./g, function (v) {
    b=(b<<6)+m.indexOf(v); l+=6;
    return l<8?'':'%'+(0x100+((b>>>(l-=8))&0xff)).toString(16).slice(-2);
  }));
}

$("#view-password").click(function(e){
    alert(decode_base64("{{replication_pw_base64}}"));

});


</script>

{% endblock %}
